<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TerraGIS - Análise e Edição GIS</title>
    
    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css?v=1" />
    
    <!-- Leaflet Draw CSS -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet.draw/1.0.4/leaflet.draw.css?v=1" />
    
    <!-- Custom CSS -->
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}?v=20251114001">
    
    <!-- Workaround: CSS inline para menus superiores -->
    <style>
    /* MENUS SUPERIORES */
    .top-menu { display: flex; gap: 8px; align-items: center; }
    .menu-item { position: relative; }
    .menu-btn { background: linear-gradient(135deg, #2A4A62 0%, #1A3A52 100%); color: #FFFFFF; border: 1px solid #3A5A72; padding: 8px 16px; font-size: 13px; font-weight: 600; cursor: pointer; border-radius: 6px; display: flex; align-items: center; gap: 8px; transition: all 0.3s ease; text-transform: uppercase; letter-spacing: 0.5px; }
    .menu-btn:hover { background: linear-gradient(135deg, #3A5A82 0%, #2A4A62 100%); border-color: #F4A460; box-shadow: 0 2px 8px rgba(244, 164, 96, 0.3); }
    .menu-btn .icon { width: 16px; height: 16px; }
    .top-dropdown { position: absolute; top: 100%; left: 0; margin-top: 4px; background: #2A2A2A; border: 1px solid #404040; border-radius: 6px; box-shadow: 0 4px 12px rgba(0, 0, 0, 0.5); min-width: 250px; z-index: 1000; padding: 8px 0; }
    .dropdown-item { width: 100%; padding: 10px 16px; background: transparent; color: #FFFFFF; border: none; text-align: left; font-size: 14px; cursor: pointer; display: flex; align-items: center; gap: 12px; transition: all 0.2s ease; }
    .dropdown-item:hover { background: linear-gradient(135deg, #2A4A62 0%, #1A3A52 100%); color: #F4A460; }
    .dropdown-item .icon { width: 18px; height: 18px; }
    
    /* CSS para menus e outros elementos está em style.css */
    </style>
</head>
<body>
    <!-- Header -->
    <header class="header">
        <div class="header-content">
            <div class="logo">
                <img src="{{ url_for('static', filename='icons/icone.png') }}" alt="TerraGIS" class="logo-img">
                <div class="logo-text">
                    <h1>TerraGIS</h1>
                    <p>Análise e Edição GIS</p>
                </div>

            </div>
            
            <!-- Menus da barra superior -->
            <nav class="top-menu">
                <div class="menu-item">
                    <button class="menu-btn" onclick="toggleTopMenu('projeto-top-menu')">
                        <img src="{{ url_for('static', filename='icons/criar_projeto_icon.png') }}" class="icon" alt=""> PROJETO ▼
                    </button>
                    <div id="projeto-top-menu" class="top-dropdown" style="display: none;">
                        <button class="dropdown-item" onclick="newProject()">
                            <img src="{{ url_for('static', filename='icons/criar_projeto_icon.png') }}" class="icon" alt=""> Novo
                        </button>
                        <button class="dropdown-item" onclick="saveProject()">
                            <img src="{{ url_for('static', filename='icons/salvar_projeto_icon.png') }}" class="icon" alt=""> Salvar
                        </button>
                        <button class="dropdown-item" onclick="openProject()">
                            <img src="{{ url_for('static', filename='icons/abrir_projeto_icon.png') }}" class="icon" alt=""> Abrir
                        </button>
                    </div>
                </div>
                
                <div class="menu-item">
                    <button class="menu-btn" onclick="toggleTopMenu('construcao-top-menu')">
                        <img src="{{ url_for('static', filename='icons/construction_icon.png') }}" class="icon" alt=""> CONSTRUÇÃO ▼
                    </button>
                    <div id="construcao-top-menu" class="top-dropdown" style="display: none;">
                        
                        <!-- POLÍGONO -->
                        <div style="position: relative;">
                            <button class="dropdown-item" onclick="toggleSubmenuInline(event, 'poligono-submenu')">
                                <img src="{{ url_for('static', filename='icons/polygon_icon.png') }}" class="icon" alt=""> POLÍGONO ▶
                            </button>
                            <div id="poligono-submenu" class="top-dropdown" style="display: none; position: absolute; left: 100%; top: 0; margin-left: 4px;">
                                
                                <!-- TABELA -->
                                <div style="position: relative;">
                                    <button class="dropdown-item" onclick="toggleSubmenuInline(event, 'poligono-tabela-submenu')">
                                        <img src="{{ url_for('static', filename='icons/table_icon.png') }}" class="icon" alt=""> TABELA ▶
                                    </button>
                                    <div id="poligono-tabela-submenu" class="top-dropdown" style="display: none; position: absolute; left: 100%; top: 0; margin-left: 4px;">
                                        <button class="dropdown-item" onclick="openCoordTableDialog()">
                                            <img src="{{ url_for('static', filename='icons/table_icon.png') }}" class="icon" alt=""> UTM
                                        </button>
                                        <button class="dropdown-item" onclick="openTabelaLatLongDialog()">
                                            <img src="{{ url_for('static', filename='icons/table_icon.png') }}" class="icon" alt=""> GEOGRÁFICA
                                        </button>
                                    </div>
                                </div>
                                
                                <!-- LISTA -->
                                <div style="position: relative;">
                                    <button class="dropdown-item" onclick="toggleSubmenuInline(event, 'poligono-lista-submenu')">
                                        <img src="{{ url_for('static', filename='icons/list_icon.png') }}" class="icon" alt=""> LISTA ▶
                                    </button>
                                    <div id="poligono-lista-submenu" class="top-dropdown" style="display: none; position: absolute; left: 100%; top: 0; margin-left: 4px;">
                                        <button class="dropdown-item" onclick="openCoordListDialog()">
                                            <img src="{{ url_for('static', filename='icons/list_icon.png') }}" class="icon" alt=""> UTM
                                        </button>
                                        <button class="dropdown-item" onclick="openListaLatLongDialog()">
                                            <img src="{{ url_for('static', filename='icons/list_icon.png') }}" class="icon" alt=""> GEOGRÁFICA
                                        </button>
                                    </div>
                                </div>
                                
                                <!-- ÂNGULOS -->
                                <div style="position: relative;">
                                    <button class="dropdown-item" onclick="toggleSubmenuInline(event, 'poligono-angulos-submenu')">
                                        <img src="{{ url_for('static', filename='icons/azimuth_icon.png') }}" class="icon" alt=""> ÂNGULOS ▶
                                    </button>
                                    <div id="poligono-angulos-submenu" class="top-dropdown" style="display: none; position: absolute; left: 100%; top: 0; margin-left: 4px;">
                                        <button class="dropdown-item" onclick="openAzimuthDialog()">
                                            <img src="{{ url_for('static', filename='icons/azimuth_icon.png') }}" class="icon" alt=""> AZIMUTE + DISTÂNCIA
                                        </button>
                                        <button class="dropdown-item" onclick="openBearingDialog()">
                                            <img src="{{ url_for('static', filename='icons/azimuth_icon.png') }}" class="icon" alt=""> RUMO + DISTÂNCIA
                                        </button>
                                    </div>
                                </div>
                                
                                <!-- SIGEF -->
                                <button class="dropdown-item" onclick="openPoligonoSIGEFDialog()">
                                    <img src="{{ url_for('static', filename='icons/sigef_icon.png') }}" class="icon" alt=""> SIGEF
                                </button>
                                
                            </div>
                        </div>
                        
                        <!-- POLILINHA -->
                        <div style="position: relative;">
                            <button class="dropdown-item" onclick="toggleSubmenuInline(event, 'polilinha-submenu')">
                                <img src="{{ url_for('static', filename='icons/polyline_icon.png') }}" class="icon" alt=""> POLILINHA ▶
                            </button>
                            <div id="polilinha-submenu" class="top-dropdown" style="display: none; position: absolute; left: 100%; top: 0; margin-left: 4px;">
                                
                                <!-- TABELA -->
                                <div style="position: relative;">
                                    <button class="dropdown-item" onclick="toggleSubmenuInline(event, 'polilinha-tabela-submenu')">
                                        <img src="{{ url_for('static', filename='icons/table_icon.png') }}" class="icon" alt=""> TABELA ▶
                                    </button>
                                    <div id="polilinha-tabela-submenu" class="top-dropdown" style="display: none; position: absolute; left: 100%; top: 0; margin-left: 4px;">
                                        <button class="dropdown-item" onclick="openPolylineCoordTableDialog()">
                                            <img src="{{ url_for('static', filename='icons/table_icon.png') }}" class="icon" alt=""> UTM
                                        </button>
                                        <button class="dropdown-item" onclick="openPolylineTabelaLatLongDialog()">
                                            <img src="{{ url_for('static', filename='icons/table_icon.png') }}" class="icon" alt=""> GEOGRÁFICA
                                        </button>
                                    </div>
                                </div>
                                
                                <!-- LISTA -->
                                <div style="position: relative;">
                                    <button class="dropdown-item" onclick="toggleSubmenuInline(event, 'polilinha-lista-submenu')">
                                        <img src="{{ url_for('static', filename='icons/list_icon.png') }}" class="icon" alt=""> LISTA ▶
                                    </button>
                                    <div id="polilinha-lista-submenu" class="top-dropdown" style="display: none; position: absolute; left: 100%; top: 0; margin-left: 4px;">
                                        <button class="dropdown-item" onclick="openPolylineCoordListDialog()">
                                            <img src="{{ url_for('static', filename='icons/list_icon.png') }}" class="icon" alt=""> UTM
                                        </button>
                                        <button class="dropdown-item" onclick="openPolylineListaLatLongDialog()">
                                            <img src="{{ url_for('static', filename='icons/list_icon.png') }}" class="icon" alt=""> GEOGRÁFICA
                                        </button>
                                    </div>
                                </div>
                                
                                <!-- ÂNGULOS -->
                                <div style="position: relative;">
                                    <button class="dropdown-item" onclick="toggleSubmenuInline(event, 'polilinha-angulos-submenu')">
                                        <img src="{{ url_for('static', filename='icons/azimuth_icon.png') }}" class="icon" alt=""> ÂNGULOS ▶
                                    </button>
                                    <div id="polilinha-angulos-submenu" class="top-dropdown" style="display: none; position: absolute; left: 100%; top: 0; margin-left: 4px;">
                                        <button class="dropdown-item" onclick="openPolylineAzimuthDialog()">
                                            <img src="{{ url_for('static', filename='icons/azimuth_icon.png') }}" class="icon" alt=""> AZIMUTE + DISTÂNCIA
                                        </button>
                                        <button class="dropdown-item" onclick="openPolylineBearingDialog()">
                                            <img src="{{ url_for('static', filename='icons/azimuth_icon.png') }}" class="icon" alt=""> RUMO + DISTÂNCIA
                                        </button>
                                    </div>
                                </div>
                                
                            </div>
                        </div>
                        
                        <!-- MÃO LIVRE -->
                        <div style="position: relative;">
                            <button class="dropdown-item" onclick="toggleSubmenuInline(event, 'maolivre-submenu')">
                                <img src="{{ url_for('static', filename='icons/freehand_icon.png') }}" class="icon" alt=""> MÃO LIVRE ▶
                            </button>
                            <div id="maolivre-submenu" class="top-dropdown" style="display: none; position: absolute; left: 100%; top: 0; margin-left: 4px;">
                                <button class="dropdown-item" onclick="openFreehandDrawingDialog('polygon')">
                                    <img src="{{ url_for('static', filename='icons/polygon_icon.png') }}" class="icon" alt=""> POLÍGONO
                                </button>
                                <button class="dropdown-item" onclick="openFreehandDrawingDialog('polyline')">
                                    <img src="{{ url_for('static', filename='icons/polyline_icon.png') }}" class="icon" alt=""> POLILINHA
                                </button>
                            </div>
                        </div>
                        
                    </div>
                </div>
                
                <div class="menu-item">
                    <button class="menu-btn" onclick="toggleTopMenu('edicao-top-menu')">
                        <img src="{{ url_for('static', filename='icons/edit_icon.png') }}" class="icon" alt=""> EDIÇÃO ▼
                    </button>
                    <div id="edicao-top-menu" class="top-dropdown" style="display: none;">
                        <!-- VÉRTICE -->
                        <div style="position: relative;">
                            <button class="dropdown-item" onclick="toggleSubmenuInline(event, 'edicao-vertice-submenu')">
                                <img src="{{ url_for('static', filename='icons/move_vertices_icon.png') }}" class="icon" alt=""> VÉRTICE ▶
                            </button>
                            <div id="edicao-vertice-submenu" class="top-dropdown" style="display: none; position: absolute; left: 100%; top: 0; margin-left: 4px;">
                                <button class="dropdown-item" onclick="ativarAdicionarVerticesMapa(); closeAllMenus();">
                                    <img src="{{ url_for('static', filename='icons/move_vertices_icon.png') }}" class="icon" alt=""> Adicionar (Mapa)
                                </button>
                                <button class="dropdown-item" onclick="ativarMoverVerticesMapa(); closeAllMenus();">
                                    <img src="{{ url_for('static', filename='icons/move_vertices_icon.png') }}" class="icon" alt=""> Mover (Mapa)
                                </button>
                                <button class="dropdown-item" onclick="ativarRemoverVerticesMapa(); closeAllMenus();">
                                    <img src="{{ url_for('static', filename='icons/remove_icon.png') }}" class="icon" alt=""> Remover
                                </button>
                                <button class="dropdown-item" onclick="ativarRenomearVerticeMapa(); closeAllMenus();">
                                    <img src="{{ url_for('static', filename='icons/rename_icon.png') }}" class="icon" alt=""> Renomear
                                </button>
                            </div>
                        </div>
                        
                        <!-- GEOMETRIA -->
                        <div style="position: relative;">
                            <button class="dropdown-item" onclick="toggleSubmenuInline(event, 'edicao-geometria-submenu')">
                                <img src="{{ url_for('static', filename='icons/move_geometry_icon.png') }}" class="icon" alt=""> GEOMETRIA ▶
                            </button>
                            <div id="edicao-geometria-submenu" class="top-dropdown" style="display: none; position: absolute; left: 100%; top: 0; margin-left: 4px;">
                                <!-- Mover -->
                                <div style="position: relative;">
                                    <button class="dropdown-item" onclick="toggleSubmenuInline(event, 'edicao-geometria-mover-submenu')">
                                        <img src="{{ url_for('static', filename='icons/move_geometry_icon.png') }}" class="icon" alt=""> Mover ▶
                                    </button>
                                    <div id="edicao-geometria-mover-submenu" class="top-dropdown" style="display: none; position: absolute; left: 100%; top: 0; margin-left: 4px;">
                                        <button class="dropdown-item" onclick="openMoverGeometriaMapaDialog(); closeAllMenus();">
                                            <img src="{{ url_for('static', filename='icons/move_geometry_icon.png') }}" class="icon" alt=""> Mapa
                                        </button>
                                        <button class="dropdown-item" onclick="openMoverGeometriaDialog(); closeAllMenus();">
                                            <img src="{{ url_for('static', filename='icons/coordinates_icon.png') }}" class="icon" alt=""> Por Distância (Digitando)
                                        </button>
                                    </div>
                                </div>
                                
                                <!-- Copiar -->
                                <button class="dropdown-item" onclick="openCopiarGeometriaDialog(); closeAllMenus();">
                                    <img src="{{ url_for('static', filename='icons/copy_icon.png') }}" class="icon" alt=""> Copiar
                                </button>
                                
                                <!-- Rotacionar -->
                                <div style="position: relative;">
                                    <button class="dropdown-item" onclick="toggleSubmenuInline(event, 'edicao-geometria-rotacionar-submenu')">
                                        <img src="{{ url_for('static', filename='icons/rotate_icon.png') }}" class="icon" alt=""> Rotacionar ▶
                                    </button>
                                    <div id="edicao-geometria-rotacionar-submenu" class="top-dropdown" style="display: none; position: absolute; left: 100%; top: 0; margin-left: 4px;">
                        <button class="dropdown-item" onclick="ativarRotacionarGeometriaMapa(); closeAllMenus();">
                            <img src="{{ url_for('static', filename='icons/rotate_icon.png') }}" class="icon" alt=""> Mapa
                        </button>
                                        <button class="dropdown-item" onclick="openRotacionarGeometriaDialog(); closeAllMenus();">
                                            <img src="{{ url_for('static', filename='icons/coordinates_icon.png') }}" class="icon" alt=""> Por Ângulo
                                        </button>
                                    </div>
                                </div>
                                
                                <!-- Converter Polilinha em Polígono -->
                                <button class="dropdown-item" onclick="converterPolilinhaEmPoligono(); closeAllMenus();">
                                    <img src="{{ url_for('static', filename='icons/polygon_icon.png') }}" class="icon" alt=""> Converter Polilinha em Polígono
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="menu-item">
                    <button class="menu-btn" onclick="toggleTopMenu('analise-top-menu')">
                        <img src="{{ url_for('static', filename='icons/analysis_icon.png') }}" class="icon" alt=""> ANÁLISE ▼
                    </button>
                    <div id="analise-top-menu" class="top-dropdown" style="display: none;">
                        <button class="dropdown-item" onclick="executarAnalisePoligono()">
                            <img src="{{ url_for('static', filename='icons/analysis_icon.png') }}" class="icon" alt=""> Análise de Polígono
                        </button>
                        <button class="dropdown-item" onclick="executarAnalisePolilinha()">
                            <img src="{{ url_for('static', filename='icons/analysis_icon.png') }}" class="icon" alt=""> Análise de Polilinha
                        </button>
                        <button class="dropdown-item" onclick="alert('Comparação de Perímetro em desenvolvimento')">
                            <img src="{{ url_for('static', filename='icons/analysis_icon.png') }}" class="icon" alt=""> Comparação de Perímetro
                        </button>
                    </div>
                </div>
                
                <div class="menu-item">
                    <button class="menu-btn" onclick="toggleTopMenu('medidas-top-menu')">
                        <img src="{{ url_for('static', filename='icons/measure_icon.png') }}" class="icon" alt=""> MEDIDAS ▼
                    </button>
                    <div id="medidas-top-menu" class="top-dropdown" style="display: none;">
                        <button class="dropdown-item" onclick="ativarMedirLinha(); closeAllMenus();">
                            <img src="{{ url_for('static', filename='icons/measure_icon.png') }}" class="icon" alt=""> Medir Linha
                        </button>
                        <button class="dropdown-item" onclick="ativarMedirArea(); closeAllMenus();">
                            <img src="{{ url_for('static', filename='icons/measure_icon.png') }}" class="icon" alt=""> Medir Área
                        </button>
                        <button class="dropdown-item" onclick="ativarMedirAzimute(); closeAllMenus();">
                            <img src="{{ url_for('static', filename='icons/measure_icon.png') }}" class="icon" alt=""> Medir Azimute
                        </button>
                        <button class="dropdown-item" onclick="ativarMedirAngulo(); closeAllMenus();">
                            <img src="{{ url_for('static', filename='icons/measure_icon.png') }}" class="icon" alt=""> Medir Ângulo
                        </button>
                        <button class="dropdown-item" onclick="ativarCoordenadaVertice(); closeAllMenus();">
                            <img src="{{ url_for('static', filename='icons/coordinates_icon.png') }}" class="icon" alt=""> Coordenada do Vértice
                        </button>
                    </div>
                </div>
                
                <div class="menu-item">
                    <button class="menu-btn" onclick="abrirLayoutImpressao(); closeAllMenus();">
                        <img src="{{ url_for('static', filename='icons/salvar_projeto_icon.png') }}" class="icon" alt=""> IMPRIMIR
                    </button>
                </div>
            </nav>
        </div>
    </header>

    <!-- Main Content -->
    <div class="main-container">
        <!-- Sidebar -->
        <aside class="sidebar">
            <!-- Nome do Projeto -->
            <div class="tool-section" style="padding: 15px; border-bottom: 1px solid #404040;">
                <span style="font-size: 14px; color: #E0E0E0;">Projeto: <strong id="project-name-sidebar" style="color: #F4A460;">Sem projeto</strong></span>
            </div>
            <!-- CAMADAS -->
            <div class="tool-section">
                <div class="submenu-container">
                    <button class="tool-btn submenu-toggle" onclick="toggleSubmenu('camadas-menu')">
                        <img src="{{ url_for('static', filename='icons/criar_projeto_icon.png') }}" class="icon" alt=""> CAMADAS <span class="arrow">▼</span>
                    </button>
                    <div id="camadas-menu" class="submenu" style="display: block;">
                        <button class="tool-btn submenu-item" onclick="addLayer()">
                            <img src="{{ url_for('static', filename='icons/add_vertices_icon.png') }}" class="icon" alt=""> Nova Camada
                        </button>
                        <div id="layers-list" class="layers-list">
                            <!-- Camadas serão adicionadas aqui -->
                        </div>
                    </div>
                </div>
            </div>
        </aside>


        <!-- Map Container -->
        <main class="map-container">
            <div id="map"></div>
        </main>
        
        <!-- Seletor de Base de Mapas (Canto Inferior Esquerdo, acima da ferramenta) -->
        <div class="basemap-selector">
            <div style="display: flex; flex-direction: column; gap: 8px;">
                <label>Base do Mapa:</label>
                <select id="baseLayerSelect" onchange="changeBaseLayer()">
                    <option value="osm">OpenStreetMap</option>
                    <option value="satellite">Google Earth (Satélite)</option>
                    <option value="sigef">SIGEF - Imóveis Certificados (INCRA)</option>
                    <option value="snci">SNCI - Terras Públicas (INCRA)</option>
                </select>
                
                <label id="ufLabel" style="display:none;">UF:</label>
                <select id="ufSelect" onchange="updateIncraLayer()" style="display:none;">
                    <option value="">Selecione</option>
                    <option value="AC">AC</option>
                    <option value="AL">AL</option>
                    <option value="AP">AP</option>
                    <option value="AM">AM</option>
                    <option value="BA">BA</option>
                    <option value="CE">CE</option>
                    <option value="DF">DF</option>
                    <option value="ES">ES</option>
                    <option value="GO">GO</option>
                    <option value="MA">MA</option>
                    <option value="MT">MT</option>
                    <option value="MS">MS</option>
                    <option value="MG">MG</option>
                    <option value="PA">PA</option>
                    <option value="PB">PB</option>
                    <option value="PR">PR</option>
                    <option value="PE">PE</option>
                    <option value="PI">PI</option>
                    <option value="RJ">RJ</option>
                    <option value="RN">RN</option>
                    <option value="RS">RS</option>
                    <option value="RO">RO</option>
                    <option value="RR">RR</option>
                    <option value="SC">SC</option>
                    <option value="SP">SP</option>
                    <option value="SE">SE</option>
                    <option value="TO">TO</option>
                </select>
            </div>
        </div>
        
        <!-- Indicador de Ferramenta Ativa (Canto Inferior Esquerdo) -->
        <div class="tool-indicator">
            <span>Ferramenta ativa: <strong id="current-tool-name">nenhuma</strong></span>
        </div>
    </div>

    <!-- Modal Novo Projeto -->
    <div id="modal-new-project" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Criar Novo Projeto</h2>
                <button class="close-btn" onclick="closeModal('modal-new-project')">&times;</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label for="project-name-input">Nome do Projeto:</label>
                    <input type="text" id="project-name-input" placeholder="Ex: Análise Fazenda Santa Maria">
                </div>
                <div class="form-group">
                    <label for="fuso-utm-select">Fuso UTM:</label>
                    <select id="fuso-utm-select">
                        <option value="">Selecione o fuso</option>
                        <option value="18S">18S</option>
                        <option value="19S">19S</option>
                        <option value="20S">20S</option>
                        <option value="21S" selected>21S</option>
                        <option value="22S">22S</option>
                        <option value="23S">23S</option>
                        <option value="24S">24S</option>
                        <option value="25S">25S</option>
                    </select>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn-secondary" onclick="closeModal('modal-new-project')">Cancelar</button>
                <button class="btn-primary" onclick="createProject()">Criar</button>
            </div>
        </div>
    </div>

    <!-- Modal Nova Camada -->
    <div id="modal-new-layer" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Nova Camada</h2>
                <button class="close-btn" onclick="closeModal('modal-new-layer')">&times;</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label for="layer-name-input">Nome da Camada:</label>
                    <input type="text" id="layer-name-input" placeholder="Ex: Polígonos de Análise">
                </div>
                <div class="form-group">
                    <label for="layer-type-select">Tipo:</label>
                    <select id="layer-type-select">
                        <option value="polygon">Polígono</option>
                        <option value="line">Linha</option>
                        <option value="point">Ponto</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="layer-color-input">Cor:</label>
                    <input type="color" id="layer-color-input" value="#3388ff">
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn-secondary" onclick="closeModal('modal-new-layer')">Cancelar</button>
                <button class="btn-primary" onclick="createLayer()">Criar</button>
            </div>
        </div>
    </div>

    <!-- Modal Lista Coordenadas UTM -->
    <div id="modal-coord-list" class="modal">
        <div class="modal-content modal-large">
            <div class="modal-header">
                <h2>Lista de Coordenadas UTM</h2>
                <button class="close-btn" onclick="closeModal('modal-coord-list')">&times;</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label for="coord-list-name">Nome da camada:</label>
                    <input type="text" id="coord-list-name" placeholder="TT" value="TT">
                </div>
                
                <div class="form-group">
                    <label for="coord-list-color">Cor:</label>
                    <input type="color" id="coord-list-color" value="#2196F3">
                </div>
                <div class="form-group">
                    <label for="coord-list-input">Coordenadas:</label>
                    <textarea id="coord-list-input" rows="10" placeholder="P-01;752000,250;8569200,750&#10;P-02;752100,500;8569200,750&#10;P-03;752100,500;8569300,000&#10;P-04;752000,250;8569300,000"></textarea>
                    <small>Formato: VÉRTICE;E;N (separado por ponto e vírgula, vírgula como decimal)</small>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn-secondary" onclick="closeModal('modal-coord-list')">Cancelar</button>
                <button class="btn-primary" onclick="createPolygonFromCoordList()">OK</button>
            </div>
        </div>
    </div>

    <!-- Modal Tabela Coordenadas UTM -->
    <div id="modal-coord-table" class="modal">
        <div class="modal-content modal-large">
            <div class="modal-header">
                <h2>Tabela de Coordenadas UTM</h2>
                <button class="close-btn" onclick="closeModal('modal-coord-table')">&times;</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label for="coord-table-name">Nome da camada:</label>
                    <input type="text" id="coord-table-name" placeholder="TT" value="TT">
                </div>
                
                <div class="form-group">
                    <label for="coord-table-color">Cor:</label>
                    <input type="color" id="coord-table-color" value="#2196F3">
                </div>
                <div class="form-group">
                    <label>Tabela de Coordenadas:</label>
                    <div class="table-container">
                        <table id="coord-table" class="data-table">
                            <thead>
                                <tr>
                                    <th>VÉRTICE</th>
                                    <th>UTM(E)</th>
                                    <th>UTM(N)</th>
                                </tr>
                            </thead>
                            <tbody id="coord-table-body">
                                <!-- Linhas serão adicionadas aqui -->
                            </tbody>
                        </table>
                    </div>
                    <div class="table-buttons">
                        <button class="btn-secondary" onclick="addTableRow('coord-table-body', 3)">+ Linha</button>
                        <button class="btn-secondary" onclick="removeTableRow('coord-table-body')">- Linha</button>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn-secondary" onclick="closeModal('modal-coord-table')">Cancelar</button>
                <button class="btn-primary" onclick="createPolygonFromCoordTable()">OK</button>
            </div>
        </div>
    </div>

    <!-- Modal Azimute + Distância -->
    <div id="modal-azimuth" class="modal">
        <div class="modal-content modal-xlarge">
            <div class="modal-header">
                <h2>Azimute e Distância</h2>
                <button class="close-btn" onclick="closeModal('modal-azimuth')">&times;</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label for="azimuth-name">Nome da camada:</label>
                    <input type="text" id="azimuth-name" placeholder="TT" value="TT">
                </div>
                
                <!-- Abas para entrada do vértice inicial -->
                <div class="tabs">
                    <div class="tab-buttons">
                        <button class="tab-btn active" onclick="switchTab('azimuth', 0)">Clique no Mapa</button>
                        <button class="tab-btn" onclick="switchTab('azimuth', 1)">UTM</button>
                        <button class="tab-btn" onclick="switchTab('azimuth', 2)">Lat/Long</button>
                    </div>
                    
                    <div class="tab-content">
                        <!-- Aba 1: Clique no Mapa -->
                        <div class="tab-pane active" id="azimuth-tab-0">
                            <button class="btn-primary" onclick="selectPointOnMap('azimuth')">Selecionar no mapa</button>
                            <input type="text" id="azimuth-coord-mapa" placeholder="Coordenadas aparecerão aqui após clique" readonly>
                        </div>
                        
                        <!-- Aba 2: UTM -->
                        <div class="tab-pane" id="azimuth-tab-1">
                            
                <div class="form-group">
                    <label for="azimuth-color">Cor:</label>
                    <input type="color" id="azimuth-color" value="#FF9800">
                            </div>
                            <div class="form-group">
                                <label for="azimuth-start-utm">Vértice inicial (id;E;N):</label>
                                <input type="text" id="azimuth-start-utm" placeholder="P-01;752000,250;8569200,750">
                            </div>
                        </div>
                        
                        <!-- Aba 3: Lat/Long -->
                        <div class="tab-pane" id="azimuth-tab-2">
                            
                            <div class="form-group">
                                <label for="azimuth-start-ll">Vértice inicial (id;longitude;latitude):</label>
                                <input type="text" id="azimuth-start-ll" placeholder='P-01;-56°23\'20,828";-14°29\'18,542"'>
                                <small>Formato: P-01;-56°23'20,828";-14°29'18,542"</small>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Tabela de Azimute e Distância -->
                <div class="form-group">
                    <label>Azimute e Distância:</label>
                    <div class="table-container">
                        <table id="azimuth-table" class="data-table">
                            <thead>
                                <tr>
                                    <th>VÉRTICE</th>
                                    <th>DISTÂNCIA</th>
                                    <th>AZIMUTE</th>
                                </tr>
                            </thead>
                            <tbody id="azimuth-table-body">
                                <!-- Linhas serão adicionadas aqui -->
                            </tbody>
                        </table>
                    </div>
                    <div class="table-buttons">
                        <button class="btn-secondary" onclick="addTableRow('azimuth-table-body', 3)">+ Linha</button>
                        <button class="btn-secondary" onclick="removeTableRow('azimuth-table-body')">- Linha</button>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn-secondary" onclick="closeModal('modal-azimuth')">Cancelar</button>
                <button class="btn-primary" onclick="createPolygonFromAzimuth()">OK</button>
            </div>
        </div>
    </div>

    <!-- Modal Rumo + Distância -->
    <div id="modal-bearing" class="modal">
        <div class="modal-content modal-xlarge">
            <div class="modal-header">
                <h2>Rumo e Distância</h2>
                <button class="close-btn" onclick="closeModal('modal-bearing')">&times;</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label for="bearing-name">Nome da camada:</label>
                    <input type="text" id="bearing-name" placeholder="TT" value="TT">
                </div>
                
                <!-- Abas para entrada do vértice inicial -->
                <div class="tabs">
                    <div class="tab-buttons">
                        <button class="tab-btn active" onclick="switchTab('bearing', 0)">Clique no Mapa</button>
                        <button class="tab-btn" onclick="switchTab('bearing', 1)">UTM</button>
                        <button class="tab-btn" onclick="switchTab('bearing', 2)">Lat/Long</button>
                    </div>
                    
                    <div class="tab-content">
                        <!-- Aba 1: Clique no Mapa -->
                        <div class="tab-pane active" id="bearing-tab-0">
                            <button class="btn-primary" onclick="selectPointOnMap('bearing')">Selecionar no mapa</button>
                            <input type="text" id="bearing-coord-mapa" placeholder="Coordenadas aparecerão aqui após clique" readonly>
                        </div>
                        
                        <!-- Aba 2: UTM -->
                        <div class="tab-pane" id="bearing-tab-1">
                            
                <div class="form-group">
                    <label for="bearing-color">Cor:</label>
                    <input type="color" id="bearing-color" value="#9C27B0">
                            </div>
                            <div class="form-group">
                                <label for="bearing-start-utm">Vértice inicial (id;E;N):</label>
                                <input type="text" id="bearing-start-utm" placeholder="P-01;752000,250;8569200,750">
                            </div>
                        </div>
                        
                        <!-- Aba 3: Lat/Long -->
                        <div class="tab-pane" id="bearing-tab-2">
                            
                            <div class="form-group">
                                <label for="bearing-start-ll">Vértice inicial (id;longitude;latitude):</label>
                                <input type="text" id="bearing-start-ll" placeholder='P-01;-56°23\'20,828";-14°29\'18,542"'>
                                <small>Formato: P-01;-56°23'20,828";-14°29'18,542"</small>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Tabela de Rumo e Distância -->
                <div class="form-group">
                    <label>Rumo e Distância:</label>
                    <div class="table-container">
                        <table id="bearing-table" class="data-table">
                            <thead>
                                <tr>
                                    <th>VÉRTICE</th>
                                    <th>DISTÂNCIA</th>
                                    <th>RUMO</th>
                                    <th>QUADRANTE</th>
                                </tr>
                            </thead>
                            <tbody id="bearing-table-body">
                                <!-- Linhas serão adicionadas aqui -->
                            </tbody>
                        </table>
                    </div>
                    <div class="table-buttons">
                        <button class="btn-secondary" onclick="addTableRow('bearing-table-body', 4)">+ Linha</button>
                        <button class="btn-secondary" onclick="removeTableRow('bearing-table-body')">- Linha</button>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn-secondary" onclick="closeModal('modal-bearing')">Cancelar</button>
                <button class="btn-primary" onclick="createPolygonFromBearing()">OK</button>
            </div>
        </div>
    </div>

    <!-- Modal Lista Lat/Long (SIGEF) -->
    <div id="modal-lista-latlong" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Lista de Coordenadas Geográficas</h2>
                <button class="modal-close" onclick="closeModal('modal-lista-latlong')">×</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label for="lista-latlong-name">Nome da camada:</label>
                    <input type="text" id="lista-latlong-name" placeholder="TT" value="TT">
                </div>
                
                
                <div class="form-group">
                    <label for="lista-latlong-color">Cor:</label>
                    <input type="color" id="lista-latlong-color" value="#4CAF50">
                </div>
                
                <div class="form-group">
                    <label for="lista-latlong-coords">Coordenadas:</label>
                    <textarea id="lista-latlong-coords" rows="10" placeholder='P-01;-56°23&#39;20,828";-14°29&#39;18,542"'></textarea>
                    <small>Formato: VÉRTICE;LONGITUDE;LATITUDE  (graus° minutos' segundos,decimais")</small>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn-secondary" onclick="closeModal('modal-lista-latlong')">Cancelar</button>
                <button class="btn-primary" onclick="createPolygonFromListaLatLong()">OK</button>
            </div>
        </div>
    </div>

    <!-- Modal Tabela Lat/Long (SIGEF) -->
    <div id="modal-tabela-latlong" class="modal">
        <div class="modal-content modal-large">
            <div class="modal-header">
                <h2>Tabela de Coordenadas Geográficas</h2>
                <button class="modal-close" onclick="closeModal('modal-tabela-latlong')">×</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label for="tabela-latlong-name">Nome da camada:</label>
                    <input type="text" id="tabela-latlong-name" placeholder="TT" value="TT">
                </div>
                
                
                <div class="form-group">
                    <label for="tabela-latlong-color">Cor:</label>
                    <input type="color" id="tabela-latlong-color" value="#4CAF50">
                </div>
                
                <div class="form-group">
                    <label>Coordenadas:</label>
                    <div class="table-buttons">
                        <button type="button" class="btn-add" onclick="addRowTabelaLatLong()">+ Linha</button>
                        <button type="button" class="btn-remove" onclick="removeRowTabelaLatLong()">- Linha</button>
                    </div>
                    <div class="table-container">
                        <table id="tabela-latlong-table" class="data-table">
                            <thead>
                                <tr>
                                    <th>VÉRTICE</th>
                                    <th>LONGITUDE (DMS)</th>
                                    <th>LATITUDE (DMS)</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <td><input type="text" placeholder="P-01"></td>
                                    <td><input type="text" placeholder='-56°23&#39;20,828"'></td>
                                    <td><input type="text" placeholder='-14°29&#39;18,542"'></td>
                                </tr>
                                <tr>
                                    <td><input type="text" placeholder="P-02"></td>
                                    <td><input type="text" placeholder='-56°23&#39;21,000"'></td>
                                    <td><input type="text" placeholder='-14°29&#39;19,000"'></td>
                                </tr>
                                <tr>
                                    <td><input type="text" placeholder="P-03"></td>
                                    <td><input type="text" placeholder='-56°23&#39;22,000"'></td>
                                    <td><input type="text" placeholder='-14°29&#39;20,000"'></td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn-secondary" onclick="closeModal('modal-tabela-latlong')">Cancelar</button>
                <button class="btn-primary" onclick="createPolygonFromTabelaLatLong()">OK</button>
            </div>
        </div>
    </div>

    <!-- Modal Vértices SIGEF -->
    <div id="modal-poligono-sigef" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>SIGEF</h2>
                <button class="modal-close" onclick="closeModal('modal-poligono-sigef')">×</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label for="sigef-nome-imovel">Nome do Imóvel/Matrícula:</label>
                    <input type="text" id="sigef-nome-imovel" placeholder="Digite o nome do imóvel ou matrícula">
                </div>
                
                
                
                <div class="form-group">
                    <label for="sigef-arquivo">Arquivo Shapefile SIGEF (ZIP):</label>
                    <input type="file" id="sigef-arquivo" accept=".zip" onchange="handleSIGEFFileSelect(event)">
                    
                </div>
                
                <div id="sigef-info" style="display:none; margin-top: 10px; padding: 10px; background: #2A2A2A; border-radius: 4px;">
                    <p><strong>Arquivo selecionado:</strong> <span id="sigef-filename"></span></p>
                    <p><strong>Vértices encontrados:</strong> <span id="sigef-vertices-count">0</span></p>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn-secondary" onclick="closeModal('modal-poligono-sigef')">Cancelar</button>
                <button class="btn-primary" onclick="importarPoligonoSIGEF()">Importar</button>
            </div>
        </div>
    </div>

    <!-- Modal Legenda INCRA -->
    <div id="modal-legend" class="modal">
        <div class="modal-content" style="max-width: 600px;">
            <div class="modal-header">
                <h2>📊 Legenda - Camadas INCRA</h2>
                <button class="close-btn" onclick="closeModal('modal-legend')">&times;</button>
            </div>
            <div class="modal-body">
                <div id="legend-content" style="text-align: center;">
                    <p>Carregando legenda...</p>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn-secondary" onclick="closeModal('modal-legend')">Fechar</button>
            </div>
        </div>
    </div>

    <!-- Modal Mover Vértice -->
    <div id="modal-mover-vertice" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>📍 Mover Vértice</h2>
                <button class="close-btn" onclick="closeModal('modal-mover-vertice')">&times;</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label for="mover-vertice-camada">Camada:</label>
                    <select id="mover-vertice-camada" onchange="loadVerticesForMove()">
                        <option value="">Selecione uma camada</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="mover-vertice-id">Vértice:</label>
                    <select id="mover-vertice-id">
                        <option value="">Selecione um vértice</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="mover-vertice-e">Nova Coordenada E (UTM):</label>
                    <input type="text" id="mover-vertice-e" placeholder="752000,250">
                </div>
                <div class="form-group">
                    <label for="mover-vertice-n">Nova Coordenada N (UTM):</label>
                    <input type="text" id="mover-vertice-n" placeholder="8569200,750">
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn-secondary" onclick="closeModal('modal-mover-vertice')">Cancelar</button>
                <button class="btn-primary" onclick="aplicarMoverVertice()">Aplicar</button>
            </div>
        </div>
    </div>

    <!-- Modal Adicionar Vértice -->
    <div id="modal-adicionar-vertice" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>➕ Adicionar Vértice</h2>
                <button class="close-btn" onclick="closeModal('modal-adicionar-vertice')">&times;</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label for="adicionar-vertice-camada">Camada:</label>
                    <select id="adicionar-vertice-camada" onchange="loadVerticesForAdd()">
                        <option value="">Selecione uma camada</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="adicionar-vertice-id">ID do Novo Vértice:</label>
                    <input type="text" id="adicionar-vertice-id" placeholder="P-05">
                </div>
                <div class="form-group">
                    <label for="adicionar-vertice-e">Coordenada E (UTM):</label>
                    <input type="text" id="adicionar-vertice-e" placeholder="752000,250">
                </div>
                <div class="form-group">
                    <label for="adicionar-vertice-n">Coordenada N (UTM):</label>
                    <input type="text" id="adicionar-vertice-n" placeholder="8569200,750">
                </div>
                <div class="form-group">
                    <label for="adicionar-vertice-posicao">Inserir após vértice:</label>
                    <select id="adicionar-vertice-posicao">
                        <option value="">Selecione posição</option>
                    </select>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn-secondary" onclick="closeModal('modal-adicionar-vertice')">Cancelar</button>
                <button class="btn-primary" onclick="aplicarAdicionarVertice()">Adicionar</button>
            </div>
        </div>
    </div>

    <!-- Modal Remover Vértice -->
    <div id="modal-remover-vertice" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>➖ Remover Vértice</h2>
                <button class="close-btn" onclick="closeModal('modal-remover-vertice')">&times;</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label for="remover-vertice-camada">Camada:</label>
                    <select id="remover-vertice-camada" onchange="loadVerticesForRemove()">
                        <option value="">Selecione uma camada</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="remover-vertice-id">Vértice:</label>
                    <select id="remover-vertice-id">
                        <option value="">Selecione um vértice</option>
                    </select>
                </div>
                <div class="form-group">
                    <small style="color: #F4A460;">⚠️ O polígono deve ter no mínimo 3 vértices.</small>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn-secondary" onclick="closeModal('modal-remover-vertice')">Cancelar</button>
                <button class="btn-primary" onclick="aplicarRemoverVertice()">Remover</button>
            </div>
        </div>
    </div>

    <!-- Modal Mover Geometria -->
    <div id="modal-mover-geometria" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>🔄 Mover Geometria</h2>
                <button class="close-btn" onclick="closeModal('modal-mover-geometria')">&times;</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label for="mover-geometria-camada">Camada:</label>
                    <select id="mover-geometria-camada">
                        <option value="">Selecione uma camada</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="mover-geometria-dx">Deslocamento em X (metros):</label>
                    <input type="text" id="mover-geometria-dx" placeholder="100,50">
                    <small>Positivo = Leste, Negativo = Oeste</small>
                </div>
                <div class="form-group">
                    <label for="mover-geometria-dy">Deslocamento em Y (metros):</label>
                    <input type="text" id="mover-geometria-dy" placeholder="200,75">
                    <small>Positivo = Norte, Negativo = Sul</small>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn-secondary" onclick="closeModal('modal-mover-geometria')">Cancelar</button>
                <button class="btn-primary" onclick="aplicarMoverGeometria()">Aplicar</button>
            </div>
        </div>
    </div>

    <!-- Leaflet JS -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    
    <!-- Leaflet Draw JS -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet.draw/1.0.4/leaflet.draw.js"></script>
    
    <!-- Leaflet.Editable for interactive editing -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet.path.drag/0.0.6/L.Path.Drag.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet-editable/1.2.0/Leaflet.Editable.min.js"></script>
    
    <!-- Turf.js for geospatial analysis -->
    <script src="https://cdn.jsdelivr.net/npm/@turf/turf@6/turf.min.js"></script>
    
    <!-- Proj4js for coordinat    <!-- Proj4js -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/proj4js/2.9.0/proj4.js"></script>
    
    <!-- html2canvas para captura de tela -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    
    <!-- leaflet-image para captura de mapas Leaflet -->
    <script src="https://cdn.jsdelivr.net/npm/leaflet-image@0.4.0/leaflet-image.js"></script>
    
    <!-- jsPDF para geração de PDF -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

    <!-- TerraGIS Core (Sistema de Camadas) -->
    <script src="{{ url_for('static', filename='js/terra-core.js') }}"></script>

    <!-- Main JavaScript -->
    <script src="{{ url_for('static', filename='js/main.js') }}"></script>
    <!-- Ferramenta Mover Geometria (Mapa) - Usa sistema de camada ativa -->
    <script src="{{ url_for('static', filename='js/mover-geometria-v2.js') }}?v={{ range(1, 999999999) | random }}"></script>
    <!-- Ferramenta Copiar Geometria - Baseada em mover-geometria-v2.js -->
    <script src="{{ url_for('static', filename='js/copiar-geometria.js') }}?v={{ range(1, 999999999) | random }}"></script>
    <!-- Ferramenta Rotacionar Geometria (Mapa) - Usa vértice mais ao norte como eixo -->
    <script src="{{ url_for('static', filename='js/rotacionar-geometria-mapa.js') }}?v={{ range(1, 999999999) | random }}"></script>
    <!-- Ferramenta Análise de Polígono - Calcula área, perímetro, erro de fechamento e tolerância NBR 13.133 -->
    <script src="{{ url_for('static', filename='js/analise-poligono.js') }}?v={{ range(1, 999999999) | random }}"></script>
    <!-- Ferramenta Análise de Polilinha - Calcula área (simulada) e perímetro de polilinhas abertas -->
    <script src="{{ url_for('static', filename='js/analise-polilinha.js') }}?v={{ range(1, 999999999) | random }}"></script>
    <!-- Ferramenta Converter Polilinha em Polígono - Cria novo polígono a partir de polilinha -->
    <script src="{{ url_for('static', filename='js/converter-polilinha-poligono.js') }}?v={{ range(1, 999999999) | random }}"></script>
    <!-- Ferramentas de Medição - Medir Linha, Área, Azimute, Ângulo e Coordenada (estilo QGIS) -->
    <script src="{{ url_for('static', filename='js/ferramentas-medicao.js') }}?v={{ range(1, 999999999) | random }}"></script>
    <!-- Módulo de Layout de Impressão - Viewport interativo + Campos editáveis + Exportação PDF A4 -->
    <script src="{{ url_for('static', filename='js/layout-impressao.js') }}?v={{ range(1, 999999999) | random }}"></script>

    <script>
// Código legado removido - agora usa mover-geometria-v2.js com sistema de camada ativa
    </script>

    <script src="{{ url_for('static', filename='js/rotacionar-geometria.js') }}?v=1760488647"></script>

    <!-- Modal Adicionar Vértice por Azimute/Rumo -->
    <div id="modal-adicionar-vertice-azimute" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>🧭 Adicionar Vértice por Azimute/Rumo</h2>
                <button class="close-btn" onclick="closeModal('modal-adicionar-vertice-azimute')">&times;</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label for="azimute-camada">1. Selecionar Geometria:</label>
                    <select id="azimute-camada" onchange="loadVerticesForAzimute()">
                        <option value="">Selecione uma camada</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="azimute-vertice-partida">2. Vértice de Partida:</label>
                    <select id="azimute-vertice-partida">
                        <option value="">Selecione um vértice</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="azimute-metodo">3. Método:</label>
                    <select id="azimute-metodo" onchange="toggleQuadranteField()">
                        <option value="azimute">Azimute + Distância</option>
                        <option value="rumo">Rumo + Distância</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="azimute-novo-id">4. ID do Novo Vértice:</label>
                    <input type="text" id="azimute-novo-id" placeholder="P-05">
                </div>
                <div class="form-group">
                    <label for="azimute-valor" id="azimute-valor-label">Azimute (°):</label>
                    <input type="text" id="azimute-valor" placeholder="45°30'15&quot; ou 45.5042">
                </div>
                <div class="form-group" id="azimute-quadrante-group" style="display: none;">
                    <label for="azimute-quadrante">Quadrante:</label>
                    <input type="text" id="azimute-quadrante" placeholder="NE, SE, SW ou NW">
                </div>
                <div class="form-group">
                    <label for="azimute-distancia">Distância (m):</label>
                    <input type="text" id="azimute-distancia" placeholder="100,50">
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn-secondary" onclick="closeModal('modal-adicionar-vertice-azimute')">Cancelar</button>
                <button class="btn-primary" onclick="aplicarAdicionarVerticeAzimute()">Inserir Vértice</button>
            </div>
        </div>
    </div>


    <!-- ===== MODAIS DE POLILINHA ===== -->
    
    <!-- Modal Tabela de Coordenadas UTM (POLILINHA) -->
    <div id="modal-polyline-coord-table" class="modal">
        <div class="modal-content modal-large">
            <div class="modal-header">
                <h2>Tabela de Coordenadas UTM</h2>
                <button class="close-btn" onclick="closeModal('modal-polyline-coord-table')">&times;</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label for="polyline-coord-table-name">Nome da camada:</label>
                    <input type="text" id="polyline-coord-table-name" placeholder="TT" value="TT">
                </div>

                <div class="form-group">
                    <label for="polyline-coord-table-color">Cor:</label>
                    <input type="color" id="polyline-coord-table-color" value="#FF8800">
                </div>
                <div class="form-group">
                    <label>Tabela de Coordenadas:</label>
                    <div class="table-container">
                        <table id="polyline-coord-table" class="data-table">
                            <thead>
                                <tr>
                                    <th>VÉRTICE</th>
                                    <th>UTM(E)</th>
                                    <th>UTM(N)</th>
                                </tr>
                            </thead>
                            <tbody id="polyline-coord-table-body">
                            </tbody>
                        </table>
                    </div>
                    <div class="table-buttons">
                        <button class="btn-secondary" onclick="addTableRow('polyline-coord-table-body', 3)">+ Linha</button>
                        <button class="btn-secondary" onclick="removeTableRow('polyline-coord-table-body')">- Linha</button>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn-secondary" onclick="closeModal('modal-polyline-coord-table')">Cancelar</button>
                <button class="btn-primary" onclick="createPolylineFromCoordTable()">OK</button>
            </div>
        </div>
    </div>

    <!-- Modal Lista de Coordenadas UTM (POLILINHA) -->
    <div id="modal-polyline-coord-list" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Lista de Coordenadas UTM</h2>
                <button class="close-btn" onclick="closeModal('modal-polyline-coord-list')">&times;</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label for="polyline-coord-list-name">Nome da camada:</label>
                    <input type="text" id="polyline-coord-list-name" placeholder="TT" value="TT">
                </div>
                <div class="form-group">
                    <label for="polyline-coord-list-color">Cor:</label>
                    <input type="color" id="polyline-coord-list-color" value="#FF8800">
                </div>
                <div class="form-group">
                    <label for="polyline-coord-list-input">Coordenadas (id;E;N):</label>
                    <textarea id="polyline-coord-list-input" rows="10" placeholder="P-01;752000,250;8569200,750&#10;P-02;752100,500;8569300,250"></textarea>
                    <small>Formato: id;E;N (um por linha, separado por ponto e vírgula)</small>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn-secondary" onclick="closeModal('modal-polyline-coord-list')">Cancelar</button>
                <button class="btn-primary" onclick="createPolylineFromCoordList()">OK</button>
            </div>
        </div>
    </div>

    <!-- Modal Tabela Lat/Long (POLILINHA) -->
    <div id="modal-polyline-tabela-latlong" class="modal">
        <div class="modal-content modal-large">
            <div class="modal-header">
                <h2>Tabela de Coordenadas Geográficas</h2>
                <button class="close-btn" onclick="closeModal('modal-polyline-tabela-latlong')">&times;</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label for="polyline-tabela-latlong-name">Nome da camada:</label>
                    <input type="text" id="polyline-tabela-latlong-name" placeholder="TT" value="TT">
                </div>
                <div class="form-group">
                    <label for="polyline-tabela-latlong-color">Cor:</label>
                    <input type="color" id="polyline-tabela-latlong-color" value="#FF8800">
                </div>
                <div class="form-group">
                    <label>Tabela de Coordenadas:</label>
                    <div class="table-container">
                        <table id="polyline-tabela-latlong" class="data-table">
                            <thead>
                                <tr>
                                    <th>VÉRTICE</th>
                                    <th>LONGITUDE</th>
                                    <th>LATITUDE</th>
                                </tr>
                            </thead>
                            <tbody id="polyline-tabela-latlong-body">
                            </tbody>
                        </table>
                    </div>
                    <div class="table-buttons">
                        <button class="btn-secondary" onclick="addTableRow('polyline-tabela-latlong-body', 3)">+ Linha</button>
                        <button class="btn-secondary" onclick="removeTableRow('polyline-tabela-latlong-body')">- Linha</button>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn-secondary" onclick="closeModal('modal-polyline-tabela-latlong')">Cancelar</button>
                <button class="btn-primary" onclick="createPolylineFromTabelaLatLong()">OK</button>
            </div>
        </div>
    </div>

    <!-- Modal Lista Lat/Long (POLILINHA) -->
    <div id="modal-polyline-lista-latlong" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Lista de Coordenadas Geográficas</h2>
                <button class="close-btn" onclick="closeModal('modal-polyline-lista-latlong')">&times;</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label for="polyline-lista-latlong-name">Nome da camada:</label>
                    <input type="text" id="polyline-lista-latlong-name" placeholder="TT" value="TT">
                </div>
                <div class="form-group">
                    <label for="polyline-lista-latlong-color">Cor:</label>
                    <input type="color" id="polyline-lista-latlong-color" value="#FF8800">
                </div>
                <div class="form-group">
                    <label for="polyline-lista-latlong-input">Coordenadas (id;longitude;latitude):</label>
                    <textarea id="polyline-lista-latlong-input" rows="10" placeholder='P-01;-56°23'20,828";-14°29'18,542"&#10;P-02;-56°23'25,123";-14°29'22,789"'></textarea>
                    <small>Formato: id;longitude;latitude (um por linha)</small>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn-secondary" onclick="closeModal('modal-polyline-lista-latlong')">Cancelar</button>
                <button class="btn-primary" onclick="createPolylineFromListaLatLong()">OK</button>
            </div>
        </div>
    </div>

    <!-- Modal Azimute + Distância (POLILINHA) -->
    <div id="modal-polyline-azimuth" class="modal">
        <div class="modal-content modal-large">
            <div class="modal-header">
                <h2>Azimute e Distância</h2>
                <button class="close-btn" onclick="closeModal('modal-polyline-azimuth')">&times;</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label for="polyline-azimuth-name">Nome da camada:</label>
                    <input type="text" id="polyline-azimuth-name" placeholder="TT" value="TT">
                </div>
                
                <!-- Abas para entrada do vértice inicial -->
                <div class="tabs">
                    <div class="tab-buttons">
                        <button class="tab-btn active" onclick="switchTab('polyline-azimuth', 0)">Clique no Mapa</button>
                        <button class="tab-btn" onclick="switchTab('polyline-azimuth', 1)">UTM</button>
                        <button class="tab-btn" onclick="switchTab('polyline-azimuth', 2)">Lat/Long</button>
                    </div>
                    
                    <div class="tab-content">
                        <!-- Aba 1: Clique no Mapa -->
                        <div class="tab-pane active" id="polyline-azimuth-tab-0">
                            <button class="btn-primary" onclick="selectPointOnMap('polyline-azimuth')">Selecionar no mapa</button>
                            <input type="text" id="polyline-azimuth-coord-mapa" placeholder="Coordenadas aparecerão aqui após clique" readonly>
                        </div>
                        
                        <!-- Aba 2: UTM -->
                        <div class="tab-pane" id="polyline-azimuth-tab-1">
                            
                            <div class="form-group">
                                <label for="polyline-azimuth-color">Cor:</label>
                                <input type="color" id="polyline-azimuth-color" value="#FF8800">
                            </div>
                            <div class="form-group">
                                <label for="polyline-azimuth-start-utm">Vértice inicial (id;E;N):</label>
                                <input type="text" id="polyline-azimuth-start-utm" placeholder="P-01;752000,250;8569200,750">
                            </div>
                        </div>
                        
                        <!-- Aba 3: Lat/Long -->
                        <div class="tab-pane" id="polyline-azimuth-tab-2">
                            
                            <div class="form-group">
                                <label for="polyline-azimuth-start-ll">Vértice inicial (id;longitude;latitude):</label>
                                <input type="text" id="polyline-azimuth-start-ll" placeholder='P-01;-56°23\'20,828";-14°29\'18,542"'>
                                <small>Formato: P-01;-56°23'20,828";-14°29'18,542"</small>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="form-group">
                    <label>Azimute e Distância:</label>
                    <div class="table-container">
                        <table id="polyline-azimuth-table" class="data-table">
                            <thead>
                                <tr>
                                    <th>VÉRTICE</th>
                                    <th>DISTÂNCIA</th>
                                    <th>AZIMUTE</th>
                                </tr>
                            </thead>
                            <tbody id="polyline-azimuth-table-body">
                                <!-- Linhas serão adicionadas aqui -->
                            </tbody>
                        </table>
                    </div>
                    <div class="table-buttons">
                        <button class="btn-secondary" onclick="addTableRow('polyline-azimuth-table-body', 3)">+ Linha</button>
                        <button class="btn-secondary" onclick="removeTableRow('polyline-azimuth-table-body')">- Linha</button>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn-secondary" onclick="closeModal('modal-polyline-azimuth')">Cancelar</button>
                <button class="btn-primary" onclick="createPolylineFromAzimuth()">OK</button>
            </div>
        </div>
    </div>

    <!-- Modal Rumo + Distância (POLILINHA) -->
    <div id="modal-polyline-bearing" class="modal">
        <div class="modal-content modal-large">
            <div class="modal-header">
                <h2>Rumo e Distância</h2>
                <button class="close-btn" onclick="closeModal('modal-polyline-bearing')">&times;</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label for="polyline-bearing-name">Nome da camada:</label>
                    <input type="text" id="polyline-bearing-name" placeholder="TT" value="TT">
                </div>
                
                <!-- Abas para entrada do vértice inicial -->
                <div class="tabs">
                    <div class="tab-buttons">
                        <button class="tab-btn active" onclick="switchTab('polyline-bearing', 0)">Clique no Mapa</button>
                        <button class="tab-btn" onclick="switchTab('polyline-bearing', 1)">UTM</button>
                        <button class="tab-btn" onclick="switchTab('polyline-bearing', 2)">Lat/Long</button>
                    </div>
                    
                    <div class="tab-content">
                        <!-- Aba 1: Clique no Mapa -->
                        <div class="tab-pane active" id="polyline-bearing-tab-0">
                            <button class="btn-primary" onclick="selectPointOnMap('polyline-bearing')">Selecionar no mapa</button>
                            <input type="text" id="polyline-bearing-coord-mapa" placeholder="Coordenadas aparecerão aqui após clique" readonly>
                        </div>
                        
                        <!-- Aba 2: UTM -->
                        <div class="tab-pane" id="polyline-bearing-tab-1">
                            
                            <div class="form-group">
                                <label for="polyline-bearing-color">Cor:</label>
                                <input type="color" id="polyline-bearing-color" value="#FF8800">
                            </div>
                            <div class="form-group">
                                <label for="polyline-bearing-start-utm">Vértice inicial (id;E;N):</label>
                                <input type="text" id="polyline-bearing-start-utm" placeholder="P-01;752000,250;8569200,750">
                            </div>
                        </div>
                        
                        <!-- Aba 3: Lat/Long -->
                        <div class="tab-pane" id="polyline-bearing-tab-2">
                            
                            <div class="form-group">
                                <label for="polyline-bearing-start-ll">Vértice inicial (id;longitude;latitude):</label>
                                <input type="text" id="polyline-bearing-start-ll" placeholder='P-01;-56°23\'20,828";-14°29\'18,542"'>
                                <small>Formato: P-01;-56°23'20,828";-14°29'18,542"</small>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="form-group">
                    <label>Rumo e Distância:</label>
                    <div class="table-container">
                        <table id="polyline-bearing-table" class="data-table">
                            <thead>
                                <tr>
                                    <th>VÉRTICE</th>
                                    <th>DISTÂNCIA</th>
                                    <th>RUMO</th>
                                    <th>QUADRANTE</th>
                                </tr>
                            </thead>
                            <tbody id="polyline-bearing-table-body">
                                <!-- Linhas serão adicionadas aqui -->
                            </tbody>
                        </table>
                    </div>
                    <div class="table-buttons">
                        <button class="btn-secondary" onclick="addTableRow('polyline-bearing-table-body', 4)">+ Linha</button>
                        <button class="btn-secondary" onclick="removeTableRow('polyline-bearing-table-body')">- Linha</button>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn-secondary" onclick="closeModal('modal-polyline-bearing')">Cancelar</button>
                <button class="btn-primary" onclick="createPolylineFromBearing()">OK</button>
            </div>
        </div>
    </div>
    <!-- Modal Desenho à Mão Livre -->
    <div id="modal-freehand-drawing" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Desenho à Mão Livre</h2>
                <button class="close-btn" onclick="closeModal('modal-freehand-drawing')">&times;</button>
            </div>
            <div class="modal-body">
                <input type="hidden" name="freehand-type" id="freehand-type" value="polygon">
                
                <div class="form-group">
                    <label for="freehand-layer-name">Nome da camada:</label>
                    <input type="text" id="freehand-layer-name" placeholder="Ex: Lote_01, Propriedade_A" value="TT">
                </div>
                
                <div class="form-group">
                    <label for="freehand-first-vertex">Nome do Primeiro Vértice:</label>
                    <input type="text" id="freehand-first-vertex" placeholder="Ex: P-01, V-001, M01" value="P-01">
                </div>
                
                <div class="form-group">
                    <label for="freehand-color">Cor:</label>
                    <input type="color" id="freehand-color" value="#FF8800">
                </div>
                

            </div>
            <div class="modal-footer">
                <button class="btn-secondary" onclick="closeModal('modal-freehand-drawing')">Cancelar</button>
                <button class="btn-primary" onclick="startFreehandDrawing()">Iniciar Desenho</button>
            </div>
        </div>
    </div>

    <div style="position: fixed; bottom: 10px; right: 10px; background: rgba(255,255,255,0.9); padding: 5px 10px; border-radius: 5px; font-size: 12px; z-index: 10000;">TerraGIS v2.18</div>
</body>
</html>
